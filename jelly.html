<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GLSL Frosted Jelly Shader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/atom-one-dark.min.css" />
  <style>
    html, body { margin: 0; height: 100%; overflow: hidden; background: #000; font-family: system-ui, sans-serif; }
    canvas { width: 100%; height: 100%; display: block; touch-action: none; }
    #codePanel { position: fixed; left: 0; right: 0; bottom: -60%; height: 60%; background: rgba(20,20,20,0.97); color:#fff; backdrop-filter: blur(8px); border-top:1px solid rgba(255,255,255,.2); padding:1rem; box-sizing:border-box; transition: bottom .3s ease; z-index:10; overflow:auto; }
    #codePanel.open { bottom: 0; }
    #toggleBtn { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color:#fff; border:none; padding:.8rem 1.6rem; border-radius:999px; font-weight:600; cursor:pointer; z-index:20; }
    pre { margin:0; font-size:13px; line-height:1.5; overflow-x:auto; }

    /* Corner label: transparent background, subtle glow */
    #brandTag {
      position: fixed; top: 14px; right: 16px; z-index: 30;
      padding: .4rem .75rem; border-radius: 999px; background: transparent;
      border: 1px solid rgba(255,255,255,0.28);
      color: #ffffff; font-weight: 600; letter-spacing: .12em; text-transform: uppercase;
      font-size: 12px; line-height: 1; pointer-events: none; user-select: none;
      text-shadow: 0 1px 6px rgba(0,0,0,0.55);
      box-shadow: 0 2px 10px rgba(0,0,0,0.25);
    }
    @media (min-width: 640px) { #brandTag { font-size: 13px; } }
  </style>
</head>
<body>
  <canvas id="glslCanvas"></canvas>

  <button id="toggleBtn">Show Code</button>
  <div id="codePanel"><pre><code class="language-glsl" id="shaderCode"></code></pre></div>

  <!-- Top-right transparent label -->
  <div id="brandTag">Claire Wang</div>

  <script src="./GlslCanvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/glsl.min.js"></script>
  <script>hljs.registerLanguage('glsl', hljsGrammarGlsl);</script>

  <script>
    const canvas = document.getElementById('glslCanvas');
    const panel  = document.getElementById('codePanel');
    const toggle = document.getElementById('toggleBtn');
    const codeEl = document.getElementById('shaderCode');
    const dpr = window.devicePixelRatio || 1;
    let sandbox;
    let pointerActive = false;
    let lastMouse = { x: 0, y: 0 };

    function resizeCanvas(){
      const w = Math.floor(canvas.clientWidth * dpr);
      const h = Math.floor(canvas.clientHeight * dpr);
      if (canvas.width !== w || canvas.height !== h) {
        canvas.width = w; canvas.height = h;
        if (sandbox && sandbox.resize) sandbox.resize();
      }
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    (async function boot(){
      sandbox = new GlslCanvas(canvas);
      const src = await fetch('shader.frag').then(r => r.text());
      sandbox.load(src);
      sandbox.resize();
      codeEl.textContent = src;
      hljs.highlightElement(codeEl);
      // do not set u_mouse here; shader treats (0,0) as neutral
    })();

    let suppressNextClick = false;
    toggle.addEventListener('click', (ev) => {
      if (suppressNextClick) { suppressNextClick = false; return; }
      toggle.style.pointerEvents = 'none';
      const open = panel.classList.toggle('open');
      toggle.textContent = open ? 'Hide Code' : 'Show Code';
      if (toggle && toggle.blur) toggle.blur();
      sandbox && sandbox.resize && sandbox.resize();
      pointerActive = false;
      // reset to neutral so clicks never imprint a position
      lastMouse.x = 0.0;
      lastMouse.y = 0.0;
      if (sandbox && sandbox.setUniform) sandbox.setUniform('u_mouse_ext', 0.0, 0.0);
      setTimeout(() => { toggle.style.pointerEvents = 'auto'; }, 300);
    });


    // Minimal pointer → u_mouse bridge for mobile drag
    function setMouseFromPointerEvent(e){
      const rect = canvas.getBoundingClientRect();
      const cssX = e.clientX - rect.left;
      const cssY = e.clientY - rect.top;
      const x = cssX * dpr;
      const y = (rect.height - cssY) * dpr; // origin at bottom-left
      lastMouse.x = x;
      lastMouse.y = y;
      if (sandbox && sandbox.setUniform) sandbox.setUniform('u_mouse_ext', lastMouse.x, lastMouse.y);
    }

    const passiveFalse = { passive: false };
    canvas.addEventListener('pointerdown', (e) => {
      if (e.pointerType === 'touch') e.preventDefault();
      pointerActive = true;
      try { canvas.setPointerCapture && canvas.setPointerCapture(e.pointerId); } catch {}
      if (e.pointerType === 'touch') toggle.style.pointerEvents = 'none';
      setMouseFromPointerEvent(e);
    }, passiveFalse);

    canvas.addEventListener('pointermove', (e) => {
      if (e.pointerType === 'touch') e.preventDefault();
      // Mobile: require active drag; Desktop: hover updates without click
      if (e.pointerType === 'touch' && !pointerActive) return;
      setMouseFromPointerEvent(e);
    }, passiveFalse);

    canvas.addEventListener('pointerup', (e) => {
      if (e.pointerType === 'touch') {
        e.preventDefault();
        pointerActive = false;
        try { canvas.releasePointerCapture && canvas.releasePointerCapture(e.pointerId); } catch {}
        toggle.style.pointerEvents = 'auto';
        lastMouse.x = 0.0; lastMouse.y = 0.0;
        if (sandbox && sandbox.setUniform) sandbox.setUniform('u_mouse_ext', 0.0, 0.0);
      }
      // For mouse, do nothing special so hover continues
    }, passiveFalse);

    window.addEventListener('pointercancel', (e) => {
      if (e.pointerType === 'touch') {
        pointerActive = false;
        try { canvas.releasePointerCapture && canvas.releasePointerCapture(e.pointerId); } catch {}
        toggle.style.pointerEvents = 'auto';
        lastMouse.x = 0.0; lastMouse.y = 0.0;
        if (sandbox && sandbox.setUniform) sandbox.setUniform('u_mouse_ext', 0.0, 0.0);
      }
    }, passiveFalse);

    // Desktop: clear effect when leaving the canvas
    canvas.addEventListener('pointerleave', (e) => {
      if (e.pointerType !== 'touch') {
        lastMouse.x = 0.0; lastMouse.y = 0.0;
        if (sandbox && sandbox.setUniform) sandbox.setUniform('u_mouse_ext', 0.0, 0.0);
      }
    });
  </script>
</body>
</html>
